<!DOCTYPE html>

<html>
  <head>
    <title>Traveler - 擲出命運骰子</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, user-scalable=no"
    />

    <link rel="stylesheet" href="../static/css/main.css" />
    <noscript
      ><link rel="stylesheet" href="static/css/noscript.css"
    /></noscript>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
  </head>
  <body class="right-sidebar is-preload">
    <div id="page-wrapper">
      <!-- Inner -->

      <!-- Nav -->
      <nav id="nav">
        <ul>
          <li><a href="./index.html">首頁</a></li>
          <li><a href="./planner.html">智慧旅行排程</a></li>
          <li><a href="./fate_dice.html">命運骰子</a></li>
          <li><a href="./emotion.html">情緒導向推薦</a></li>
        </ul>
      </nav>

      <!-- Main -->

      <div class="wrapper style1">
        <div class="container">
          <div class="row gtr-200">
            <div class="col-8 col-12-mobile" id="content">
              <article id="main" class="special">
                <header class="major">
                  <h2>擲出屬於你的旅程</h2>
                </header>
                <br />
                <div class="emotiondate">
                  <div class="dateheader">
                    <h2><i class="fa-solid fa-arrow-right"></i>&nbsp;Step 1</h2>
                    <br />
                  </div>
                  <form id="customScheduleForm" class="row gtr-50">
                    <div class="col-12">
                      <label for="datechosen" class="form-label"
                        >選擇縣市 &nbsp;<i class="fa-solid fa-city"></i
                      ></label>
                      <select id="datechosen" class="form-select" required>
                        <option value="">-- 請選擇 --</option>
                        <option value="keelung">基隆</option>
                        <option value="taipei">台北</option>
                        <option value="new_taipei">新北</option>
                        <option value="taoyuan">桃園</option>
                        <option value="hsinchu_city">新竹</option>
                        <option value="miaoli">苗栗</option>
                        <option value="taichung">臺中</option>
                        <option value="changhua">彰化</option>
                        <option value="nantou">南投</option>
                        <option value="yunlin">雲林</option>
                        <option value="chiayi_city">嘉義</option>
                        <option value="tainan">臺南</option>
                        <option value="kaohsiung">高雄</option>
                        <option value="pingtung">屏東</option>
                        <option value="yilan">宜蘭</option>
                        <option value="hualien">花蓮</option>
                        <option value="taitung">臺東</option>
                      </select>
                    </div>
                  </form>
                </div>
              </article>
              <hr />
              <article id="main">
                <header>
                  <div class="emotiondate">
                    <div class="dateheader">
                      <h2>
                        <i class="fa-solid fa-arrow-right"></i>&nbsp;Step 2
                      </h2>
                      <br />
                      <h3>
                        等待骰子結束運行後將提供您一個旅遊主題&nbsp;<i
                          class="fa-solid fa-dice"
                        ></i>
                      </h3>
                    </div>
                  </div>
                </header>
                <br /><br />
                <section>
                  <div class="dice-container">
                    <div class="scene">
                      <div class="cube">
                        <div
                          class="cube__face cube__face--front"
                          data-result="美食之旅"
                        >
                          <img
                            src="../static/images/S__80920580_0.jpg"
                            alt="美食之旅"
                          />
                        </div>
                        <div
                          class="cube__face cube__face--back"
                          data-result="自然風景"
                        >
                          <img
                            src="../static/images/S__80920581_0.jpg"
                            alt="自然風景"
                          />
                        </div>
                        <div
                          class="cube__face cube__face--right"
                          data-result="文化歷史"
                        >
                          <img
                            src="../static/images/S__80920582_0.jpg"
                            alt="文化歷史"
                          />
                        </div>
                        <div
                          class="cube__face cube__face--left"
                          data-result="冒險活動"
                        >
                          <img
                            src="../static/images/S__80920583_0.jpg"
                            alt="冒險活動"
                          />
                        </div>
                        <div
                          class="cube__face cube__face--top"
                          data-result="購物娛樂"
                        >
                          <img
                            src="../static/images/S__80920584_0.jpg"
                            alt="購物娛樂"
                          />
                        </div>
                        <div
                          class="cube__face cube__face--bottom"
                          data-result="休閒放鬆"
                        >
                          <img
                            src="../static/images/S__80920585_0 (1).jpg"
                            alt="休閒放鬆"
                          />
                        </div>
                      </div>
                    </div>
                    <br />
                    <div class="dice-result" id="resultBox">
                      <h3>您的旅遊主題為：</h3>
                      <br />
                      <div class="diceinner">
                        <div id="resultLabel"></div>
                      </div>
                      <div class="Start">
                        <button class="startButton">點擊開始</button>
                      </div>
                    </div>
                  </div>
                </section>
                <hr />
                <div class="startRec">
                  <button type="submit" class="startRec">開始推薦</button>
                </div>
              </article>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div id="footer">
      <div class="container">
        <!-- Contact -->
        <section class="contact">
          <header>
            <h3>聯絡我們</h3>
          </header>
          <p>若有任何問題，非常歡迎您透過以下管道聯繫我們</p>
          <ul class="icons">
            <li>
              <a href="#" class="icon brands fa-facebook-f"
                ><span class="label">Facebook</span></a
              >
            </li>
            <li>
              <a href="#" class="icon brands fa-instagram"
                ><span class="label">Instagram</span></a
              >
            </li>
          </ul>
        </section>

        <!-- Copyright -->
        <div class="copyright">
          <ul class="menu">
            <li>&copy; Untitled. All rights reserved.</li>
            <li>Design: <a href="http://html5up.net">HTML5 UP</a></li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="../static/js/cube.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
    <script src="../static/js/jquery.min.js"></script>
    <script src="../static/js/jquery.dropotron.min.js"></script>
    <script src="../static/js/jquery.scrolly.min.js"></script>
    <script src="../static/js/jquery.scrollex.min.js"></script>
    <script src="../static/js/browser.min.js"></script>
    <script src="../static/js/breakpoints.min.js"></script>
    <script src="../static/js/util.js"></script>
    <script src="../static/js/main.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const startRecButton = document.querySelector(".startRec button"); // 「開始推薦」按鈕
        const citySelect = document.getElementById("datechosen"); // 縣市選擇下拉選單
        const resultLabel = document.getElementById("resultLabel"); // 顯示骰子結果的區域

        // 監聽「開始推薦」按鈕點擊事件
        if (startRecButton && citySelect && resultLabel) {
          startRecButton.addEventListener("click", function (event) {
            event.preventDefault(); // 阻止表單預設提交行為

            const selectedCity = citySelect.value; // 獲取選擇的縣市
            const selectedTheme = resultLabel.textContent.trim(); // 從 resultLabel 獲取骰子擲出的主題

            // 前端驗證：檢查使用者是否已選擇縣市且已擲出骰子結果
            if (!selectedCity || selectedCity === "") {
              alert("請先選擇一個縣市！");
              return;
            }
            // 判斷 resultLabel 是否為空或仍在顯示「骰子滾動中...」
            if (!selectedTheme || selectedTheme === "骰子滾動中..." || selectedTheme === "") {
              alert("請先擲出命運骰子，獲取旅遊主題！");
              return;
            }

            // 準備要發送到後端的資料 (使用 FormData)
            const formData = new FormData();
            formData.append("region", selectedCity); // 傳送縣市
            formData.append("theme", selectedTheme); // 傳送骰子結果 (主題)

            // 使用 Fetch API 發送 POST 請求到 Django 後端
            fetch("http://127.0.0.1:8000/fate_dice/roll_dice/", { // **請確認這個 URL /roll_dice/ 與你的 Django `urls.py` 設定相符**
              method: "POST",
              body: formData,
              // 如果你的 Django 後端沒有使用 @csrf_exempt，你需要加入 CSRF token
              // 例如：
              // headers: {
              //     'X-CSRFToken': getCookie('csrftoken') // 需要定義 getCookie 函式
              // }
            })
              .then((response) => {
                if (!response.ok) { // 檢查 HTTP 狀態碼，如果不是 2xx，則拋出錯誤
                  throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json(); // 解析 JSON 回應
              })
              .then((data) => {
                if (data.success) {
                  console.log("成功獲取推薦資料:", data);
                  // 將後端回傳的推薦資料、主題、縣市及來源頁面儲存到 localStorage
                  localStorage.setItem("recommended_data", JSON.stringify(data.data));
                  localStorage.setItem("travel_theme", data.theme);
                  localStorage.setItem("travel_region", data.region);
                  localStorage.setItem("source_page", "fate_dice"); // 標記來源頁面為 "fate_dice"

                  // 成功後，跳轉到 result.html 頁面
                  window.location.href = "./result.html"; 
                } else {
                  // 顯示後端回傳的錯誤訊息
                  alert("推薦失敗: " + data.message);
                  console.error("後端錯誤訊息:", data.message);
                }
              })
              .catch((error) => {
                console.error("Fetch 請求失敗:", error);
                alert("請求失敗，請檢查網路或稍後再試。");
              });
          });
        } else {
          console.warn("找不到「開始推薦」按鈕、縣市選擇或結果顯示區域。請檢查 HTML ID/Class。");
        }

        // 如果需要 CSRF token，可以加入這個輔助函式 (目前後端有 @csrf_exempt 所以不需要)
        // function getCookie(name) {
        //     let cookieValue = null;
        //     if (document.cookie && document.cookie !== '') {
        //         const cookies = document.cookie.split(';');
        //         for (let i = 0; i < cookies.length; i++) {
        //             const cookie = cookies[i].trim();
        //             if (cookie.substring(0, name.length + 1) === (name + '=')) {
        //                 cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        //                 break;
        //             }
        //         }
        //     }
        //     return cookieValue;
        // }
      });
    </script>
  </body>
</html>
