<!DOCTYPE html>

<html>
  <head>
    <title>Traveler - 擲出命運骰子</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, user-scalable=no"
    />

    <link rel="stylesheet" href="../static/css/main.css" />
    <noscript
      ><link rel="stylesheet" href="static/css/noscript.css"
    /></noscript>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
  </head>
  <body class="right-sidebar is-preload">
    <div id="page-wrapper">
      <!-- Inner -->

      <!-- Nav -->
      <nav id="nav">
        <ul>
          <li><a href="./index.html">首頁</a></li>
          <li><a href="./planner.html">智慧旅行排程</a></li>
          <li><a href="./fate_dice.html">命運骰子</a></li>
          <li><a href="./emotion.html">情緒導向推薦</a></li>
        </ul>
      </nav>

      <!-- Main -->

      <div class="wrapper style1">
        <div class="container">
          <div class="row gtr-200">
            <div class="col-8 col-12-mobile" id="content">
              <article id="main" class="special">
                <header class="major">
                  <h2>擲出屬於你的旅程</h2>
                </header>
                <br />
                <div class="emotiondate">
                  <div class="dateheader">
                    <h2><i class="fa-solid fa-arrow-right"></i>&nbsp;Step 1</h2>
                    <br />
                  </div>
                  <form id="customScheduleForm" class="row gtr-50">
                    <div class="col-12">
                      <label for="datechosen" class="form-label"
                        >選擇縣市 &nbsp;<i class="fa-solid fa-city"></i
                      ></label>
                      <select id="datechosen" class="form-select" required>
                        <option value="">-- 請選擇 --</option>
                        <option value="keelung">基隆</option>
                        <option value="taipei">台北</option>
                        <option value="new_taipei">新北</option>
                        <option value="taoyuan">桃園</option>
                        <option value="hsinchu_city">新竹</option>
                        <option value="miaoli">苗栗</option>
                        <option value="taichung">臺中</option>
                        <option value="changhua">彰化</option>
                        <option value="nantou">南投</option>
                        <option value="yunlin">雲林</option>
                        <option value="chiayi_city">嘉義</option>
                        <option value="tainan">臺南</option>
                        <option value="kaohsiung">高雄</option>
                        <option value="pingtung">屏東</option>
                        <option value="yilan">宜蘭</option>
                        <option value="hualien">花蓮</option>
                        <option value="taitung">臺東</option>
                      </select>
                    </div>
                  </form>
                </div>
              </article>
              <hr />
              <article id="main">
                <header>
                  <div class="emotiondate">
                    <div class="dateheader">
                      <h2>
                        <i class="fa-solid fa-arrow-right"></i>&nbsp;Step 2
                      </h2>
                      <br />
                      <h3>
                        等待骰子結束運行後將提供您一個旅遊主題&nbsp;<i
                          class="fa-solid fa-dice"
                        ></i>
                      </h3>
                    </div>
                  </div>
                </header>
                <br /><br />
                <section>
                  <div class="dice-container">
                    <div class="scene">
                      <div class="cube">
                        <div
                          class="cube__face cube__face--front"
                          data-result="美食之旅"
                        >
                          <img
                            src="../static/images/S__80920580_0.jpg"
                            alt="美食之旅"
                          />
                        </div>
                        <div
                          class="cube__face cube__face--back"
                          data-result="自然風景"
                        >
                          <img
                            src="../static/images/S__80920581_0.jpg"
                            alt="自然風景"
                          />
                        </div>
                        <div
                          class="cube__face cube__face--right"
                          data-result="文化歷史"
                        >
                          <img
                            src="../static/images/S__80920582_0.jpg"
                            alt="文化歷史"
                          />
                        </div>
                        <div
                          class="cube__face cube__face--left"
                          data-result="冒險活動"
                        >
                          <img
                            src="../static/images/S__80920583_0.jpg"
                            alt="冒險活動"
                          />
                        </div>
                        <div
                          class="cube__face cube__face--top"
                          data-result="購物娛樂"
                        >
                          <img
                            src="../static/images/S__80920584_0.jpg"
                            alt="購物娛樂"
                          />
                        </div>
                        <div
                          class="cube__face cube__face--bottom"
                          data-result="休閒放鬆"
                        >
                          <img
                            src="../static/images/S__80920585_0 (1).jpg"
                            alt="休閒放鬆"
                          />
                        </div>
                      </div>
                    </div>
                    <br />
                    <div class="dice-result" id="resultBox">
                      <h3>您的旅遊主題為：</h3>
                      <br />
                      <div class="diceinner">
                        <div id="resultLabel"></div>
                      </div>
                      <div class="Start">
                        <button class="startButton">點擊開始</button>
                      </div>
                    </div>
                  </div>
                </section>
                <hr />
                <div class="startRec">
                  <button type="submit" class="startRec">開始推薦</button>
                </div>
              </article>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div id="footer">
      <div class="container">
        <!-- Contact -->
        <section class="contact">
          <header>
            <h3>聯絡我們</h3>
          </header>
          <p>若有任何問題，非常歡迎您透過以下管道聯繫我們</p>
          <ul class="icons">
            <li>
              <a href="#" class="icon brands fa-facebook-f"
                ><span class="label">Facebook</span></a
              >
            </li>
            <li>
              <a href="#" class="icon brands fa-instagram"
                ><span class="label">Instagram</span></a
              >
            </li>
          </ul>
        </section>

        <!-- Copyright -->
        <div class="copyright">
          <ul class="menu">
            <li>&copy; Untitled. All rights reserved.</li>
            <li>Design: <a href="http://html5up.net">HTML5 UP</a></li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="../static/js/cube.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
    <script src="../static/js/jquery.min.js"></script>
    <script src="../static/js/jquery.dropotron.min.js"></script>
    <script src="../static/js/jquery.scrolly.min.js"></script>
    <script src="../static/js/jquery.scrollex.min.js"></script>
    <script src="../static/js/browser.min.js"></script>
    <script src="../static/js/breakpoints.min.js"></script>
    <script src="../static/js/util.js"></script>
    <script src="../static/js/main.js"></script>
    <script>
      // 建議將整個事件監聽器包裹在 DOMContentLoaded 內
      document.addEventListener("DOMContentLoaded", function () {
        document.querySelector(".startRec button").addEventListener("click", function (event) {
          event.preventDefault();

          // 獲取地點與骰子結果
          const city = document.getElementById("datechosen").value;
          const theme = document.getElementById("resultLabel").innerText.trim();

          if (!city || !theme) {
            alert("請確保已選擇地點並擲出骰子！");
            return;
          }

          // 不需要 requestData = JSON.parse(fateDiceData); 因為 fateDiceData 在這裡未定義且不必要
          // 直接使用已獲取的 city 和 theme 變數
          const formData = new URLSearchParams();
          formData.append("region", city);
          formData.append("theme", theme); // 雖然後端目前沒有用 theme 篩選，但保持傳遞

          fetch("http://127.0.0.1:8000/fate_dice/roll_dice/", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded", // 更改為表單數據類型
            },
            body: formData, // 直接傳遞 formData
          })
            .then((response) => {
              if (!response.ok) {
                // 處理非 2xx 響應
                return response.json().then((errorData) => {
                  throw new Error(errorData.message || "Fate Dice API 請求失敗");
                });
              }
              return response.json();
            })
            .then((data) => {
              console.log("Fate Dice API 回應:", data);
              if (data.success) {
                sessionStorage.setItem("fateDiceResult", JSON.stringify(data));
                // 成功獲取數據後，導向到結果頁面
                window.location.href = "./fate_diceResult.html"; // 正確的跳轉
              } else {
                alert("命運骰子推薦失敗: " + data.message);
                // 如果失敗，在當前頁面處理錯誤，避免不必要的跳轉
                // 例如：可以考慮顯示一個錯誤訊息，而不是重新導向
                window.location.reload(); // 或者刷新頁面讓使用者重新選擇
              }
            })
            .catch((error) => {
              console.error("Fate Dice API 錯誤:", error);
              alert("發生錯誤: " + error.message);
              // 發生錯誤時，在當前頁面處理錯誤
              window.location.reload(); // 或者刷新頁面讓使用者重新選擇
            });
        });
      }); // DOMContentLoaded 的結束括號
    </script>
  </body>
</html>
